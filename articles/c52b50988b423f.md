---
title: "PlanetScaleとPrismaを組み合わせて使う"
emoji: "📘"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["planetscale", "prisma", "mysql"]
published: false
---

無料枠のあるデータベースとしてPlanetScaleを使うことになったので、Prismaとの組み合わせ方を調べてみました。

## PlanetScaleとは

PlanetScaleは、MySQL互換のサーバーレスデータベースです。PlanetScaleの機能には、ダウンタイムなしのマイグレーションや、ブランチ機能があります。

https://planetscale.com/

## PlanetScaleでPrismaを使う場合に考慮すること

PlanetScaleでPrismaを使う場合に考慮することは、主に次の2つです。

- PlanetScaleは外部キー制約をサポートしていないので、Prismaが外部キーを使わないように設定する
- PlanetScaleのブランチ機能と、Prismaのマイグレーション機能の組み合わせ方

## 外部キー制約の対応について

### 外部キー制約をPrismaでエミュレートする

Prismaでは、モデル間にリレーションを設定すると、整合性を保証するために外部キー制約が付与されます。PlanetScaleは外部キー制約をサポートしていないため、そのままマイグレーションを行うとエラーになります。

そのため、PlanetScaleでPrismaを使う場合は、外部キー制約を作成せずにエミュレートするモード（`relationMode = "prisma"`）を使います。

```ts
datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}
```

外部キー制約をエミュレートするというのは、参照整合性を保証してくれる・参照アクションを実行してくれるという事です。

Prismaでリレーションを設定した場合のデフォルトの挙動は、`ON DELETE RESTRICT`・`ON UPDATE CASCADE`です。つまり、外部キーで参照されているレコードを削除することはできません。

```ts
// 具体例
```

利用する機会はあまりないかもしれませんが、削除時の参照アクションを`CASCADE`にすると、参照されているレコードを削除したときに参照しているレコードを削除できます。

```ts
// 具体例
```

### 外部キー制約の代わりにインデックスを付与してクエリを最適化する

MySQLでは、外部キー制約を設定すると外部キーにインデックスが設定されます。そのため、Prismaでリレーションの取得する場合は、インデックスアクセス（`type=ref`）で高速に行えます。

```ts
const userWithPosts = await prisma.user.findUniqueOrThrow({
  where: { id: 1 },
  include: { posts: true },
})
```

```sql
-- ユニークインデックスでユーザーを取得する
-- インデックスでユーザーを取得する
```

つまり、外部キー制約を使わない場合は代わりにインデックスの設定が必要です。インデックスを設定していない場合はエディタ上でワーニングが出るため、気づきやすいと思います。

TODO: ワーニングが出ている画像を入れる

:::details 中間テーブルの場合
:::

:::details 主キーが外部キーの場合
:::

## PlanetScaleのブランチ機能について

[Branching — PlanetScale Documentation](https://planetscale.com/docs/concepts/branching)

PlanetScaleのブランチ機能とPrisma Migrateの組み合わせ方の前に、PlanetScaleのブランチ機能について説明します。

PlanetScaleのブランチは、独立したデータベースのインスタンスです。つまり、あるブランチのスキーマやデータを変更しても、他のブランチに影響を与えることはありません。

PlanetScaleのブランチには、開発用（Development branch）と本番用（Production branch）の2種類あります。本番用のブランチは、高トラフィックを想定してレプリカが用意されていることや、Safe migrationsを有効化できるという違いがあります。

[Safe migrations — PlanetScale Documentation](https://planetscale.com/docs/concepts/safe-migrations)

Safe migrationsは、スキーマを直接変更することを禁止し、ダウンタイムなしのマイグレーションを行うための機能です。Safe migratiosを有効化した場合は、次のような手順で本番用のブランチのスキーマの変更を行います。

- 本番用のブランチから開発用のブランチを作成する
- 開発用のブランチのスキーマに変更を加える
- 開発用のブランチから本番用のブランチにデプロイリクエストを作成する
- デプロイリクエストをデプロイして、スキーマの変更を反映する

## PlanetScaleのブランチ機能とPrisma Migrateの組み合わせ方

PlanetScaleとPrisma Migrateを組み合わせる方法には、PlanetScaleのブランチ機能を使う方法と、ブランチ機能を使わない方法があります。

PlanetScaleやPrismaのドキュメントでは、ブランチ機能を使う方法が推奨されています。ブランチ機能を使うとダウンタイムなしのマイグレーションが強制される反面、スキーマの変更に手間がかかるデメリットがあります。

### PlanetScaleのブランチ機能を使う場合

`prisma migrate`を使ったワークフローでは、Prismaのスキーマと実際のDBの差分をもとにマイグレーションファイルを作成します。しかし、この方法はPlanetScaleのブランチを使ったワークフローとマッチしません。なぜかというと、Prismaで作成するマイグレーションファイルと、PlanetScaleが実行するマイグレーションが違う可能性があるからです。

TODO: prisma migrate devで自動生成した場合はあまりないかもしれないので、~する場合はないかもしれませんが〜

例えば、`prisma migrate`でカラムをリネームするマイグレーションファイルを作成したとします。PlanetScaleでこのマイグレーションを適用したブランチをマージしようとすると、（マージ先のブランチのテーブルにレコードがある場合は）エラーになってマージできません。

TODO: エラーになる画像を入れる

なぜかというと、PlanetScaleではカラムのリネームの変更を検知しないからです。つまり、カラムをリネームした場合は古いカラムが削除され、新しいカラムを追加されたと判定されてしまいます。

以上の理由から、`prisma migrate`の代わりに`prisma db push`を使うことが推奨されています。`prisma db push`は、Prismaスキーマのに合うようにデータベースを変更するコマンドです。

### PlanetScaleのブランチ機能を使わない場合

ブランチ機能を使う場合は、データベースのスキーマを変更するワークフローが少し複雑になってしまいます。

例えばカラムをリネームする場合は、1. 新しいカラムを追加してデプロイする 2. 古いカラムのデータを新しいカラムにコピーする 3. 古いカラムを削除してデプロイするというように、2回スキーマの変更をデプロイする必要があります。

TODO: カラムの変更についてのドキュメント

これらはマイグレーションのダウンタイムをなくすためには必要な工程ですが、開発中でスキーマの変更が頻繁にある場合は手間だと思います。その場合はPlanetScaleのブランチ機能を使わずに、`prisma migrate`を使う方法もあると思います。

具体的には、mainブランチの`Safe migrations`をオフにして、開発時はローカルのデータベースを対象に`prisma migrate`を行います。そして、mainブランチへの反映には`prisma migrate deploy`を使います。

`prisma db push`を使う方法がPlanetScaleに寄せたワークフローだとすると、この方法はPrismaに寄せたワークフローという感じです。

## PlanetScaleのブランチ機能を使う場合のワークフロー

実際にやってみます。

## まだ分かっていないこと

- Vercelのプレビュー環境から、PlanetScaleのブランチに接続する方法。PlanetScaleのパスワードがブランチ毎なので、CIでブランチを毎回作成する必要があるのかなと思いました。
- ひとまずブランチ機能を使わないワークフローで開発していますが、実際に運用するとなるとブランチ機能を使った方が良さそうです。その場合はDBを使ったテストをどうするかが課題になりそうです。
- ブランチを作成するときにデータもコピーする機能があるようですが、まだ試せていません

## 感想

ブランチ機能は慣れるまでに少し時間がかかりそうですが、良い設計と開発（= ダウンタイムなしのマイグレーション）が強制されるいい機能だなと思いました。

カラムを変更する場合のワークフローはexpand and contract patternと呼ばれているようなので、こちらも調べてみようと思います。

## 参考

- [Using Prisma with PlanetScale](https://www.prisma.io/docs/guides/database/planetscale)
- [Prisma with PlanetScale quickstart — PlanetScale Documentation](https://planetscale.com/docs/prisma/prisma-quickstart)
