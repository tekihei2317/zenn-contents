---
title: "PrismaãŒç™ºè¡Œã™ã‚‹SQLã‚’è¦³å¯Ÿã—ã¦ã¿ã‚‹ï¼ˆå‚ç…§ç³»ï¼‰"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["prisma", "sql", "nodejs"]
published: true
publication_name: "gibjapan"
---

## å‹•æ©Ÿ

ä¸»ã«å‚ç…§ç³»ã§ã€PrismaãŒã©ã®ã‚ˆã†ãªSQLã‚’ç™ºè¡Œã—ã¦ã„ã‚‹ã®ã‹ãŒæ°—ã«ãªã£ãŸãŸã‚ã€èª¿ã¹ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã–ã£ãã‚Šè¦‹ãŸæ„Ÿã˜ã§ã¯ã€ç™ºè¡Œã•ã‚Œã‚‹SQLã«ã¤ã„ã¦è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ãŒãªã‹ã£ãŸãŸã‚ã€å®Ÿéš›ã«Prisma Clientã‚’å‹•ã‹ã—ã¦ç¢ºèªã—ã¦ã¿ã¾ã—ãŸã€‚

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³

- prisma 4.10.1
- MySQL 8.0.31

## æº–å‚™

ä»Šå›ã¯ã€æ¬¡ã®ãƒ–ãƒ­ã‚°ã‚¢ãƒ—ãƒªé¢¨ã®ã‚¹ã‚­ãƒ¼ãƒã‚’ä½¿ã£ã¦è©¦ã—ã¦ã¿ã¾ã™ã€‚

```ts:schema.prisma
model User {
  id      Int          @id @default(autoincrement())
  email   String       @unique
  name    String?
  posts   Post[]
  profile UserProfile?
}

model Post {
  id        Int     @id @default(autoincrement())
  title     String
  content   String?
  published Boolean @default(false)
  author    User    @relation(fields: [authorId], references: [id])
  authorId  Int
  createdAt DateTime @default(now())
}

model UserProfile {
  userId      Int     @id
  displayName String
  bio         String?
  user        User    @relation(fields: [userId], references: [id])
}
```

ç™ºè¡Œã•ã‚Œã‚‹SQLã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã¯ã€Prisma Clientã«`log`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã—ã¾ã™ã€‚

```ts
export const prisma = new PrismaClient({
  log: ["query"],
});
```

ä¸€ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦ã®æ“ä½œã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«Prisma Clientã®è¨˜è¿°ã¨ç™ºè¡Œã•ã‚Œã‚‹SQLãŒã»ã¼åŒã˜ãªã®ã§ã€ä¸»ã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹æ“ä½œã‚’ä¸­å¿ƒã«è¦‹ã¦ã„ãã¾ã™ã€‚

```ts
await prisma.post.findMany({
  select: {
    id: true,
    title: true,
    content: true,
  },
  where: {
    authorId: 1,
    published: true,
  },
  orderBy: { createdAt: 'desc' },
  limit: 10,
})
```

```sql
-- ç™ºè¡Œã•ã‚Œã‚‹SQL
SELECT
  `simple_blog`.`Post`.`id`,
  `simple_blog`.`Post`.`title`,
  `simple_blog`.`Post`.`content`
FROM
  `simple_blog`.`Post`
WHERE (
  `simple_blog`.`Post`.`authorId` = ? AND
  `simple_blog`.`Post`.`published` = ?
)
ORDER BY `simple_blog`.`Post`.`createdAt` DESC
LIMIT ? OFFSET ?
```

## PrismaãŒã§ãã‚‹ã“ã¨

Prismaã§ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã—ã¦ã§ãã‚‹æ“ä½œã¯ã€ä¸»ã«ä»¥ä¸‹ã®3ã¤ã§ã™ã€‚

- ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹
- ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§æ¤œç´¢ã™ã‚‹
- ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ä¸¦ã¹æ›¿ãˆã‚‹

ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹æ“ä½œä»¥å¤–ã§ã¯ã€é›†ç´„ç³»ã®APIï¼ˆ`aggregate`ã¨`groupBy`ï¼‰ã‚‚ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯è©¦ã—ã¦ã„ã¾ã›ã‚“ã€‚

## ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹

### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹

ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€`include`ã¾ãŸã¯`select`ã‚’ä½¿ã„ã¾ã™ã€‚

```tsx
// (User & { posts: Post[] })[]
const usersWithPosts1 = await prisma.user.findMany({
  include: { posts: true },
  take: 10,
})

// { posts: Post[] }[]
const usersWithPosts2 = await prisma.user.findMany({
  select: { posts: true },
  take: 10,
})
```

ç™ºè¡Œã•ã‚Œã‚‹SQLã¯ä»¥ä¸‹ã§ã™ã€‚`include`ã¨`select`ã®ã©ã¡ã‚‰ã¨ã‚‚ã€Userã‚’å–å¾—ã—ãŸå¾Œã«ã€ãã®IDã‚’ä½¿ã£ã¦Postã‚’å–å¾—ã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

```sql
-- include
SELECT `simple_blog`.`User`.`id`, `simple_blog`.`User`.`email`, `simple_blog`.`User`.`name`
FROM `simple_blog`.`User`
WHERE 1=1
ORDER BY `simple_blog`.`User`.`id` ASC
LIMIT ? OFFSET ?

SELECT `simple_blog`.`Post`.`id`, `simple_blog`.`Post`.`title`, `simple_blog`.`Post`.`content`, `simple_blog`.`Post`.`published`, `simple_blog`.`Post`.`authorId`, `simple_blog`.`Post`.`createdAt`
FROM `simple_blog`.`Post`
WHERE `simple_blog`.`Post`.`authorId` IN (?,?,?,?,?,?,?,?,?,?)

-- select
SELECT `simple_blog`.`User`.`id`
FROM `simple_blog`.`User`
WHERE 1=1 ORDER BY `simple_blog`.`User`.`id` ASC
LIMIT ? OFFSET ?

SELECT `simple_blog`.`Post`.`id`, `simple_blog`.`Post`.`title`, `simple_blog`.`Post`.`content`, `simple_blog`.`Post`.`published`, `simple_blog`.`Post`.`authorId`, `simple_blog`.`Post`.`createdAt`
FROM `simple_blog`.`Post`
WHERE `simple_blog`.`Post`.`authorId` IN (?,?,?,?,?,?,?,?,?,?)
```

:::details è£œè¶³: includeã¨selectã®é•ã„ã¨ä½¿ã„åˆ†ã‘

`include`ã¨`select`ã®é•ã„ã¯ä»¥ä¸‹ã®2ç‚¹ã§ã™ã€‚

- `include`ã¯ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã—ã‹ä½¿ãˆãªã„ãŒã€`select`ã¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸¡æ–¹ã«ä½¿ãˆã‚‹
- `include`ã‚’ä½¿ã£ãŸå ´åˆã¯ã€è¦ªã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨ã¦ã®ã‚«ãƒ©ãƒ ãŒæš—é»™çš„ã«å–å¾—ã•ã‚Œã‚‹

æ³¨æ„ç‚¹ã¨ã—ã¦ã€`include`ã¨`select`ã¯åŒã˜éšå±¤ã«æ›¸ã‘ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãªãœä¸¡æ–¹ã‚’æ›¸ã‘ãªã„ã‹ã¨ã„ã†ã¨ã€`include`ã¨`select`ã¯åŒã˜ã‚ˆã†ãªå½¹å‰²ã®ãŸã‚ã€ã©ã¡ã‚‰ã«æ›¸ã‹ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚Œã°ã„ã„ã®ã‹åˆ¤æ–­ã§ããªã„ã‹ã‚‰ã ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

```ts
// ä»¥ä¸‹ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
await prisma.post.findMany({
  // post.titleã¨ã‚¿ã‚°ã‚’å–å¾—ã™ã‚‹ã®ã‹ã€post.*ã¨ã‚¿ã‚°ã‚’å–å¾—ã™ã‚‹ã®ã‹åˆ¤æ–­ã§ããªã„
  select: { title: true, tags: true },
  include: { tags: true },
  take: 10,
})
```

ä¸¡æ–¹ã‚’ä½¿ã„ãŸããªã£ãŸå ´åˆã¯ã€`include`ã§ã§ãã‚‹ã“ã¨ã¯`select`ã§ã§ãã‚‹ã®ã§ã€`select`ã‚’ä½¿ãˆã°è‰¯ã„ã§ã™ã€‚

å‚è€ƒ: [Relation queries (Concepts)](https://www.prisma.io/docs/concepts/components/prisma-client/relation-queries#select-specific-relation-fields)

:::

### å–å¾—ã™ã‚‹ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«æ¡ä»¶ã‚’ã¤ã‘ã‚‹

å–å¾—ã™ã‚‹ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«æ¡ä»¶ã‚’ã¤ã‘ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ãã®å ´åˆã¯ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹SQLã«æ¡ä»¶ãŒä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚

```ts
const userWithPosts3 = await prisma.user.findMany({
  select: {
    posts: {
      select: { id: true, title: true },
      where: { published: true },
    },
  },
  take: 10,
});
```

```sql
SELECT `simple_blog`.`User`.`id`
FROM `simple_blog`.`User`
WHERE 1=1 ORDER BY
`simple_blog`.`User`.`id` ASC
LIMIT ? OFFSET ?

SELECT `simple_blog`.`Post`.`id`, `simple_blog`.`Post`.`title`, `simple_blog`.`Post`.`authorId` 
FROM `simple_blog`.`Post`
WHERE
  (`simple_blog`.`Post`.`published` = ? AND
  `simple_blog`.`Post`.`authorId` IN (?,?,?,?,?,?,?,?,?,?))
```

### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä»¶æ•°ã‚’å–å¾—ã™ã‚‹

`include`ã‚„`select`ã§ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä»¶æ•°ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```ts
const userWithPostCount = await prisma.user.findMany({
  select: {
    id: true,
    name: true,
    _count: true,
  },
  take: 10,
});
```

ã“ã®å ´åˆã¯ã€ä»¶æ•°ã‚’å–å¾—ã™ã‚‹ã‚¯ã‚¨ãƒªãŒJOINã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

```sql
SELECT
  `simple_blog`.`User`.`id`,
  `simple_blog`.`User`.`name`,
  `aggr_selection_0_Post`.`_aggr_count_posts`
FROM
  `simple_blog`.`User`
  LEFT JOIN (
    SELECT `simple_blog`.`Post`.`authorId`, COUNT(*) AS `_aggr_count_posts`
    FROM `simple_blog`.`Post`
    WHERE 1=1
    GROUP BY `simple_blog`.`Post`.`authorId`
  ) AS `aggr_selection_0_Post`
    ON (`simple_blog`.`User`.`id` = `aggr_selection_0_Post`.`authorId`)
WHERE 1=1
ORDER BY `simple_blog`.`User`.`id`
ASC LIMIT ? OFFSET ?
```

## ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§æ¤œç´¢ã™ã‚‹

### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã§æ¤œç´¢ã™ã‚‹

å–å¾—ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã§çµã‚Šè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€æŠ•ç¨¿ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§çµã‚Šè¾¼ã‚€ãŸã‚ã«ã¯ã€æ¬¡ã®ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚

```tsx
const result = await prisma.post.findMany({
  select: { id: true, title: true },
  where: {
    published: false,
    author: {
      email: "test1000@example.com",
    },
  },
});
```

æ¬¡ã®SQLãŒç™ºè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚æ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDã‚’ã‚µãƒ–ã‚¯ã‚¨ãƒªã§å–å¾—ã—ã¦ã‹ã‚‰ã€INå¥ã§çµã‚Šè¾¼ã‚“ã§ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

```sql
SELECT
  `simple_blog`.`Post`.`id`, `simple_blog`.`Post`.`title`
FROM `simple_blog`.`Post`
WHERE (
  `simple_blog`.`Post`.`published` = ? AND
  (`simple_blog`.`Post`.`id`) IN (
    SELECT `t0`.`id`
    FROM
      `simple_blog`.`Post` AS `t0`
      INNER JOIN `simple_blog`.`User` AS `j0` ON (`j0`.`id`) = (`t0`.`authorId`)
    WHERE (`j0`.`email` = ? AND `t0`.`id` IS NOT NULL)
  )
)
```

ã‚µãƒ–ã‚¯ã‚¨ãƒªã§JOINã—ã¦ã„ã‚‹ç†ç”±ãŒæ°—ã«ãªã£ãŸã®ã§ã™ãŒã€å¤–éƒ¨ã‚­ãƒ¼ãŒè¤‡æ•°ã‚«ãƒ©ãƒ ã‹ã‚‰ãªã‚‹å ´åˆ[^1]ã«INãŒä½¿ãˆãªããªã‚‹ã“ã¨ã‚’è€ƒæ…®ã—ã¦ã„ã‚‹ã®ã‹ãªã¨æ€ã„ã¾ã—ãŸã€‚

```sql
-- ã“ã®ã‚¯ã‚¨ãƒªã‚‚åŒç­‰ã ãŒã€å¤–éƒ¨ã‚­ãƒ¼ãŒè¤‡åˆã®å ´åˆã¯ä½¿ãˆãªã„ï¼ˆINã®ã‚µãƒ–ã‚¯ã‚¨ãƒªã¯1ã‚«ãƒ©ãƒ ã—ã‹é¸æŠã§ããªã„ãŸã‚ï¼‰
SELECT
  `simple_blog`.`Post`.`id`, `simple_blog`.`Post`.`title`
FROM `simple_blog`.`Post`
WHERE (
  `simple_blog`.`Post`.`published` = ? AND
  (`simple_blog`.`Post`.`authorId`) IN (
    SELECT `t0`.`id`
    FROM
      `simple_blog`.`User` as `t0`
    WHERE (`t0`.`email` = ? AND `t0`.`id` IS NOT NULL)
  )
)
```

### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å­˜åœ¨æ€§ã§æ¤œç´¢ã™ã‚‹

ã¾ãŸã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å­˜åœ¨æ€§ã§æ¤œç´¢ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒto-manyå´ã®å ´åˆã¯`some`ãƒ»`none`ãƒ»`every`ã‚’ä½¿ã„ã€to-oneå´ã®å ´åˆã¯`{ is: null }`ã¾ãŸã¯ã€`{ isNot: null }`ã‚’ä½¿ã„ã¾ã™ã€‚

```ts
const userWithSomePosts = await prisma.user.findMany({
  select: { id: true, name: true },
  where: {
    posts: { some: {} },
  },
  take: 10,
});
```

```sql
SELECT
  `simple_blog`.`User`.`id`,
  `simple_blog`.`User`.`name`
FROM `simple_blog`.`User`
WHERE
  (`simple_blog`.`User`.`id`) IN (
    SELECT `t0`.`id`
    FROM
      `simple_blog`.`User` AS `t0`
      INNER JOIN `simple_blog`.`Post` AS `j0` ON (`j0`.`authorId`) = (`t0`.`id`)
      WHERE (1=1 AND `t0`.`id` IS NOT NULL)
  )
ORDER BY `simple_blog`.`User`.`id` ASC LIMIT ? OFFSET ?
```

```ts
const userWithProfile = await prisma.user.findMany({
  select: { id: true, name: true },
  where: {
    profile: { isNot: null },
  },
  take: 10,
});
```

```sql
SELECT
  `simple_blog`.`User`.`id`,
  `simple_blog`.`User`.`name`
FROM `simple_blog`.`User`
WHERE (
  NOT (`simple_blog`.`User`.`id`) NOT IN (
    SELECT `simple_blog`.`UserProfile`.`userId`
    FROM `simple_blog`.`UserProfile`
    WHERE `simple_blog`.`UserProfile`.`userId` IS NOT NULL
  )
)
ORDER BY `simple_blog`.`User`.`id` ASC LIMIT ? OFFSET ?
```

ç¾æ™‚ç‚¹ã§ã¯ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å€‹æ•°ã§æ¤œç´¢ã™ã‚‹ã“ã¨ã¯ã§ããªã„ã‚ˆã†ã§ã™ï¼ˆ[å‚è€ƒ](https://github.com/prisma/prisma/issues/3821)ï¼‰ã€‚

## ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ä¸¦ã¹æ›¿ãˆã‚‹


### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ä¸¦ã¹æ›¿ãˆã‚‹

ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ä¸¦ã¹æ›¿ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
const sortedPosts = await prisma.post.findMany({
  select: { id: true, title: true },
  orderBy: {
    author: { name: "desc" },
  },
  take: 5,
});
```

ã“ã®ã¨ãã¯JOINã‚’ã—ã¦ã„ã¾ã—ãŸã€‚

```sql
SELECT
  `simple_blog`.`Post`.`id`,
  `simple_blog`.`Post`.`title`
FROM
  `simple_blog`.`Post`
  LEFT JOIN `simple_blog`.`User` AS `orderby_1_User`
    ON (`simple_blog`.`Post`.`authorId` = `orderby_1_User`.`id`)
WHERE 1=1
ORDER BY `orderby_1_User`.`name` DESC LIMIT ? OFFSET ?
```

### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å€‹æ•°ã§ä¸¦ã¹æ›¿ãˆã‚‹

ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å€‹æ•°ã§ä¸¦ã¹æ›¿ãˆã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```ts
const activeUsers = await prisma.user.findMany({
  select: { id: true, name: true },
  orderBy: {
    posts: {
      _count: "desc",
    },
  },
  take: 10,
});
```

ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä»¶æ•°ã‚’è¨ˆç®—ã—ãŸã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’JOINã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

```sql
SELECT
  `simple_blog`.`User`.`id`,
  `simple_blog`.`User`.`name`
FROM
  `simple_blog`.`User`
  LEFT JOIN (
    SELECT `simple_blog`.`Post`.`authorId`, COUNT(*) AS `orderby_aggregator`
    FROM `simple_blog`.`Post`
    WHERE 1=1
    GROUP BY `simple_blog`.`Post`.`authorId`
  ) AS `orderby_1_Post`
    ON (`simple_blog`.`User`.`id` = `orderby_1_Post`.`authorId`)
WHERE 1=1
ORDER BY COALESCE(`orderby_1_Post`.`orderby_aggregator`, ?) DESC
LIMIT ? OFFSET ?
```

## ã¾ã¨ã‚

è¦³å¯Ÿã—ãŸçµæœã€ä»¥ä¸‹ã®3ç‚¹ãŒã„ãˆãã†ã§ã™ã€‚

- `select`ã‚„`include`ã§ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ã¨ãã¯ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã”ã¨ã«SQLãŒç™ºè¡Œã•ã‚Œã‚‹
    - ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å€‹æ•°ã‚’å–å¾—ã™ã‚‹å ´åˆã¯ä¾‹å¤–ã§ã€countã‚’å–å¾—ã™ã‚‹ã‚¯ã‚¨ãƒªãŒJOINã•ã‚Œã‚‹
- ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§æ¤œç´¢ã™ã‚‹ã¨ãã¯ã€ã‚µãƒ–ã‚¯ã‚¨ãƒªã§ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢ã—ã¦ã‹ã‚‰INãŒä½¿ã‚ã‚Œã‚‹
- ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚½ãƒ¼ãƒˆã™ã‚‹ã¨ãã¯JOINãŒä½¿ã‚ã‚Œã‚‹

ã¾ãŸã€SQLã®çµ„ã¿ç«‹ã¦ã¯ã€å–å¾—ãƒ»æ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆã§ç‹¬ç«‹ã—ã¦è¡Œã‚ã‚Œã¦ã„ãã†ã§ã™ã€‚ä¾‹ãˆã°ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®æ¤œç´¢ã¨ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®ä¸¦ã¹æ›¿ãˆã‚’åŒæ™‚ã«è¡Œã£ã¦ã¿ã‚‹ã¨ã€æ¤œç´¢ç”¨ã®ã‚µãƒ–ã‚¯ã‚¨ãƒªã¨ã‚½ãƒ¼ãƒˆç”¨ã®JOINãŒã‚ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

:::details ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®æ¤œç´¢ã¨ä¸¦ã¹æ›¿ãˆã‚’åŒæ™‚ã«è¡Œã†
```ts
await prisma.post.findMany({
  where: {
    author: { name: { contains: "tom" } },
  },
  orderBy: {
    author: { name: "desc" },
  },
});
```

```sql
SELECT
  `simple_blog`.`Post`.`id`,
  `simple_blog`.`Post`.`title`,
  `simple_blog`.`Post`.`content`,
  `simple_blog`.`Post`.`published`,
  `simple_blog`.`Post`.`authorId`,
  `simple_blog`.`Post`.`createdAt`
FROM
   `simple_blog`.`Post`
   LEFT JOIN `simple_blog`.`User` AS `orderby_1_User`
    ON (`simple_blog`.`Post`.`authorId` = `orderby_1_User`.`id`)
WHERE
  (`simple_blog`.`Post`.`id`) IN (
    SELECT `t0`.`id`
    FROM
      `simple_blog`.`Post` AS `t0`
      INNER JOIN `simple_blog`.`User` AS `j0` ON (`j0`.`id`) = (`t0`.`authorId`)
    WHERE (`j0`.`name` LIKE ? AND `t0`.`id` IS NOT NULL)
  )
ORDER BY `orderby_1_User`.`name` DESC
```
:::

ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çš„ã«ã¯ã‚ã¾ã‚Šå•é¡Œãªã•ãã†ã§ã™ãŒã€JOINã‚’ä½¿ã†ãªã‚‰ã°ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ã‚ãªãã¦ã‚‚ã§ãã‚‹ã®ã§ã€è‹¥å¹²å†—é•·ãªSQLãŒç™ºè¡Œã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚


### å‹å®‰å…¨ãªã‚¯ã‚¨ãƒªã«ã¤ã„ã¦ã®æ„Ÿæƒ³

å®Ÿéš›ã«ä½¿ã£ã¦ã„ã¦ã€æ¤œç´¢ã§æŒ‡å®šã—ãŸæ¡ä»¶ãŒã€å–å¾—çµæœã®å‹ã«åæ˜ ã•ã‚Œãªã„ã“ã¨ãŒæ°—ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã€‚ä¾‹ãˆã°ã€`UserProfile`ï¼ˆto-oneå´ï¼‰ãŒå­˜åœ¨ã—ãªã„ã¨ã„ã†æ¡ä»¶ã‚’æ›¸ã„ãŸã¨ã—ã¦ã‚‚ã€å–å¾—çµæœã¯`UserProfile | null`ã«ãªã‚Šã¾ã™ã€‚[^2]

ä»–ã«ã¯å€‹äººçš„ãªå°è±¡ã§ã™ãŒã€é›†è¨ˆã®ã‚¯ã‚¨ãƒªãŒå˜ç´”ãªã‚±ãƒ¼ã‚¹ã§ãªã‘ã‚Œã°é›£ã—ã„ã®ã‹ãªã¨ã„ã†æ°—ã‚‚ã—ã¦ã„ã¾ã™ã€‚ãªãœã‹ã¨ã„ã†ã¨ã€PrismaãŒFROMå¥ã§JOINã™ã‚‹ã“ã¨ãŒå°‘ãªã„ã‹ã‚‰ã§ã™ã€‚

ã“ã‚Œã‚‰ã®ã‚±ãƒ¼ã‚¹ã¯ã€[pg-typed](https://github.com/adelsz/pgtyped)ã‚„[sqlc](https://sqlc.dev/)ï¼ˆGoï¼‰ãªã©ã®ã€SQLã‹ã‚‰å‹ã‚’ç”Ÿæˆã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå‘ã„ã¦ã„ãã†ã§ã™ã€‚[^3]

## å‚è€ƒ

- [Select fields (Concepts)](https://www.prisma.io/docs/concepts/components/prisma-client/select-fields)
- [Relation queries (Concepts)](https://www.prisma.io/docs/concepts/components/prisma-client/relation-queries)
- [Filtering and sorting (Concepts)](https://www.prisma.io/docs/concepts/components/prisma-client/filtering-and-sorting)

[^1]: è¤‡åˆå¤–éƒ¨ã‚­ãƒ¼ã¨ã„ã†ã®ã§ã—ã‚‡ã†ã‹ã€‚
[^2]: INNER JOINã™ã‚Œã°è§£æ±ºã§ãã‚‹ã‚‚ã®ã®ã€ä»Šåº¦ã¯`user.profile`ã®ã‚ˆã†ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã“ã¨ãŒæ°—ã«ãªã‚Šãã†ã§ã™ã€‚ãã®å ´åˆã¯ã€çµå±€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ãªã‚“ã¨ã‹ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
[^3]: Node.js x MySQLã§ã¯ã©ã¡ã‚‰ã‚‚ä½¿ãˆãªã„ã®ã§ç¾¨ã¾ã—ã„â€¦
