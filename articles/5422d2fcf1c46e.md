---
title: "PrismaãŒç™ºè¡Œã™ã‚‹SQLã‚’è¦³å¯Ÿã—ã¦ã¿ã‚‹ï¼ˆå‚ç…§ç³»ï¼‰"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["prisma", "sql", "nodejs"]
published: false
---

## å‹•æ©Ÿ

ä¸»ã«å‚ç…§ç³»ã§ã€PrismaãŒã©ã®ã‚ˆã†ãªSQLã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã®ã‹ãŒæ°—ã«ãªã£ãŸãŸã‚ã€èª¿ã¹ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã–ã£ãã‚Šè¦‹ãŸæ„Ÿã˜ã§ã¯ã€å®Ÿè¡Œã•ã‚Œã‚‹SQLã«ã¤ã„ã¦è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ãŒãªã‹ã£ãŸãŸã‚ã€å®Ÿéš›ã«å®Ÿè¡Œã—ã¦ç¢ºèªã—ã¦ã¿ã¾ã—ãŸã€‚

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³

- prisma 4.10.1
- MySQL 8.0.31

## æº–å‚™

ä»Šå›ã¯ã€æ¬¡ã®ãƒ–ãƒ­ã‚°ã‚¢ãƒ—ãƒªé¢¨ã®ã‚¹ã‚­ãƒ¼ãƒã‚’ä½¿ã£ã¦è©¦ã—ã¦ã¿ã¾ã™ã€‚

```ts
model User {
  id      Int          @id @default(autoincrement())
  email   String       @unique
  name    String?
  posts   Post[]
  profile UserProfile?
}

model Post {
  id        Int     @id @default(autoincrement())
  title     String
  content   String?
  published Boolean @default(false)
  author    User    @relation(fields: [authorId], references: [id])
  authorId  Int
}

model UserProfile {
  userId      Int     @id
  displayName String
  bio         String?
  user        User    @relation(fields: [userId], references: [id])
}
```

å®Ÿè¡Œã•ã‚Œã‚‹SQLã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã¯ã€Prisma Clientã«`log`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã—ã¾ã™ã€‚

```ts
export const prisma = new PrismaClient({
  log: ["query"],
});
```

ä¸€ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦ã®æ“ä½œã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã•ã‚Œã‚‹SQLã¨ã»ã¼åŒã˜ãªã®ã§ã€ä¸»ã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹æ“ä½œã‚’ä¸­å¿ƒã«è¦‹ã¦ã„ãã¾ã™ã€‚

```ts
await prisma.post.findMany({
  select: {
    id: true,
    title: true,
    content: true,
  },
  where: {
    authorId: 1,
    published: true,
  },
  orderBy: { createdAt: 'desc' },
  limit: 10,
})
```

```sql
-- å®Ÿè¡Œã•ã‚Œã‚‹SQL
SELECT
  `simple_blog`.`Post`.`id`,
  `simple_blog`.`Post`.`title`,
  `simple_blog`.`Post`.`content`
FROM
  `simple_blog`.`Post`
WHERE (
  `simple_blog`.`Post`.`authorId` = ? AND
  `simple_blog`.`Post`.`published` = ?
)
ORDER BY `simple_blog`.`Post`.`createdAt` DESC
LIMIT ? OFFSET ?
```

## PrismaãŒã§ãã‚‹ã“ã¨

Prismaã§ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã—ã¦ã§ãã‚‹æ“ä½œã¯ã€ä¸»ã«ä»¥ä¸‹ã®3ã¤ã§ã™ã€‚

- ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹
- ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§æ¤œç´¢ã™ã‚‹
- ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ä¸¦ã¹æ›¿ãˆã‚‹

é›†ç´„ç³»ã®APIï¼ˆ`aggregate`ã¨`groupBy`ï¼‰ã‚‚ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯è©¦ã—ã¦ã„ã¾ã›ã‚“ã€‚ãã‚Œã§ã¯é †ç•ªã«è¦‹ã¦ã„ãã¾ã™ã€‚

## ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹

ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€`include`ã¾ãŸã¯`select`ã‚’ä½¿ã„ã¾ã™ã€‚

```tsx
// (User & { posts: Post[] })[]
const usersWithPosts1 = await prisma.user.findMany({
  include: { posts: true },
  take: 10,
})

// { posts: Post[] }[]
const usersWithPosts2 = await prisma.user.findMany({
  select: { posts: true },
  take: 10,
})
```

ç™ºè¡Œã•ã‚Œã‚‹SQLã¯ä»¥ä¸‹ã§ã™ã€‚ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã”ã¨ã«ã‚¯ã‚¨ãƒªãŒç™ºè¡Œã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

```sql
-- include
SELECT `simple_blog`.`User`.`id`, `simple_blog`.`User`.`email`, `simple_blog`.`User`.`name`
FROM `simple_blog`.`User`
WHERE 1=1
ORDER BY `simple_blog`.`User`.`id` ASC
LIMIT ? OFFSET ?;

SELECT `simple_blog`.`Post`.`id`, `simple_blog`.`Post`.`title`, `simple_blog`.`Post`.`content`, `simple_blog`.`Post`.`published`, `simple_blog`.`Post`.`authorId`, `simple_blog`.`Post`.`createdAt`
FROM `simple_blog`.`Post`
WHERE `simple_blog`.`Post`.`authorId` IN (?,?,?,?,?,?,?,?,?,?);

-- select
SELECT `simple_blog`.`User`.`id`
FROM `simple_blog`.`User`
WHERE 1=1 ORDER BY `simple_blog`.`User`.`id` ASC
LIMIT ? OFFSET ?

SELECT `simple_blog`.`Post`.`id`, `simple_blog`.`Post`.`title`, `simple_blog`.`Post`.`content`, `simple_blog`.`Post`.`published`, `simple_blog`.`Post`.`authorId`, `simple_blog`.`Post`.`createdAt`
FROM `simple_blog`.`Post`
WHERE `simple_blog`.`Post`.`authorId` IN (?,?,?,?,?,?,?,?,?,?)
```

:::details è£œè¶³: includeã¨selectã®é•ã„ã¨ä½¿ã„åˆ†ã‘

`include`ã¨`select`ã®å½¹å‰²ã¯ã»ã¨ã‚“ã©åŒã˜ã§ã™ã€‚`include`ãŒæ›¸ã‘ã‚‹å ´æ‰€ã«ã¯`select`ãŒæ›¸ã‘ã€`select`ãŒæ›¸ã‘ã‚‹å ´æ‰€ã«ã¯`include`ã‚‚ã‹ã‘ã¾ã™ã€‚

includeã¨selectã®é•ã„ã¯ã€includeã¯ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã—ã‹ä½¿ãˆãªã„ã“ã¨ã§ã™ã€‚ã¾ãŸã€includeã‚’ä½¿ã£ãŸå ´åˆã¯ã€è¦ªã®ã‚«ãƒ©ãƒ ã¯æš—é»™çš„ã«å…¨ã¦å–å¾—ã•ã‚Œã¾ã™ã€‚

```ts
// éšå±¤ã¯ã€include or selectâ†’ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³â†’include or selectã¨ã„ã†æ„Ÿã˜
```

æ³¨æ„ç‚¹ã¯ã€includeã¨selectã¯åŒã˜éšå±¤ã«æ›¸ã‘ãªã„ã“ã¨ã§ã™ã€‚ç†ç”±ã¯ã€selectã¨includeã®å½¹å‰²ãŒè¢«ã£ã¦ã„ã‚‹ãŸã‚ã€prismaãŒã©ã¡ã‚‰ã‚’å„ªå…ˆã™ã‚Œã°ã‚ã‹ã‚‰ãªã„ã‹ã‚‰ã ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ã“ã†ã—ãŸããªã£ãŸå ´åˆã¯ã€includeã§ã§ãã‚‹ã“ã¨ã¯selectã§ã§ãã‚‹ã®ã§ã€selectã‚’ä½¿ãˆã°è‰¯ã„ã§ã™ã€‚

```ts
// ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ä¾‹
await prisma.post.findMany({
  // post.titleã¨ã‚¿ã‚°ã‚’å–å¾—ã™ã‚‹ã®ã‹ã€post.*ã¨ã‚¿ã‚°ã‚’å–å¾—ã™ã‚‹ã®ã‹åˆ¤æ–­ã§ããªã„
  select: { title: true, tags: true },
  include: { tags: true },
  take: 10,
})
```

:::

å–å¾—ã™ã‚‹ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«æ¡ä»¶ã‚’ã¤ã‘ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ãã®å ´åˆã¯ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ã‚¯ã‚¨ãƒªã«æ¡ä»¶ãŒä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚

```ts
const userWithPosts3 = await prisma.user.findMany({
  select: {
    posts: {
      select: { id: true, title: true },
      where: { published: true },
    },
  },
  take: 10,
});
```

```sql
-- å®Ÿè¡Œã•ã‚Œã‚‹SQL
SELECT `simple_blog`.`User`.`id`
FROM `simple_blog`.`User`
WHERE 1=1 ORDER BY
`simple_blog`.`User`.`id` ASC
LIMIT ? OFFSET ?

SELECT `simple_blog`.`Post`.`id`, `simple_blog`.`Post`.`title`, `simple_blog`.`Post`.`authorId` 
FROM `simple_blog`.`Post`
WHERE
  (`simple_blog`.`Post`.`published` = ? AND
  `simple_blog`.`Post`.`authorId` IN (?,?,?,?,?,?,?,?,?,?))
```

includeã‚„selectã§ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä»¶æ•°ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```ts
const userWithPostCount = await prisma.user.findMany({
  select: {
    id: true,
    name: true,
    _count: true,
  },
  take: 10,
});
```

ã“ã®å ´åˆã¯ã€ä»¶æ•°ã‚’å–å¾—ã™ã‚‹ã‚¯ã‚¨ãƒªãŒJOINã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

```sql
SELECT
  `simple_blog`.`User`.`id`,
  `simple_blog`.`User`.`name`,
  `aggr_selection_0_Post`.`_aggr_count_posts`
FROM
  `simple_blog`.`User`
  LEFT JOIN (
    SELECT `simple_blog`.`Post`.`authorId`, COUNT(*) AS `_aggr_count_posts`
    FROM `simple_blog`.`Post`
    WHERE 1=1
    GROUP BY `simple_blog`.`Post`.`authorId`
  ) AS `aggr_selection_0_Post`
    ON (`simple_blog`.`User`.`id` = `aggr_selection_0_Post`.`authorId`)
WHERE 1=1
ORDER BY `simple_blog`.`User`.`id`
ASC LIMIT ? OFFSET ?
```

## ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§æ¤œç´¢ã™ã‚‹

å–å¾—ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§çµã‚Šè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€æŠ•ç¨¿ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§çµã‚Šè¾¼ã‚€ãŸã‚ã«ã¯ã€æ¬¡ã®ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚

```tsx
const result = await prisma.post.findMany({
  where: {
    published: false,
    author: {
      email: "test1000@example.com",
    },
  },
});
```

æ¬¡ã®SQLãŒç™ºè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚æ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDã‚’ã‚µãƒ–ã‚¯ã‚¨ãƒªã§å–å¾—ã—ã¦ã‹ã‚‰ã€INå¥ã§çµã‚Šè¾¼ã‚“ã§ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚ï¼ˆTODO: 3éšå±¤ã®ãƒã‚¹ãƒˆã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼‰

```tsx

```

ã¾ãŸã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å­˜åœ¨æ€§ã§æ¤œç´¢ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒ-to-manyå´ã®å ´åˆã¯someãƒ»noneãƒ»everyã‚’ä½¿ã„ã€-to-oneå´ã®å ´åˆã¯{ is: null }ã¾ãŸã¯ã€{ isNot: null }ã‚’ä½¿ã„ã¾ã™ã€‚

```tsx
noneã®ã‚¯ã‚¨ãƒª
```

```tsx
ç™ºè¡Œã•ã‚Œã‚‹SQL
```

```tsx
is nullã®ã‚¯ã‚¨ãƒª
```

```tsx
ç™ºè¡Œã•ã‚Œã‚‹SQL
```

ç¾æ™‚ç‚¹ã§ã¯ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å€‹æ•°ã§æ¤œç´¢ã™ã‚‹ã“ã¨ã¯ã§ããªã„ã‚ˆã†ã§ã™ã€‚

## ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ä¸¦ã¹æ›¿ãˆã‚‹

ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ä¸¦ã¹æ›¿ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```tsx
const sortedPosts = await prisma.post.findMany({
  orderBy: {
    author: { name: "desc" },
  },
  take: 10,
});
```

ã“ã®ã¨ãã¯JOINã‚’ã—ã¦ã„ã¾ã—ãŸã€‚

```tsx

```

ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å€‹æ•°ã§ä¸¦ã¹æ›¿ãˆã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```tsx
const activeUsers = await prisma.user.findMany({
  select: { id: true, name: true },
  orderBy: {
    posts: {
      _count: "desc",
    },
  },
  take: 10,
});
```

ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä»¶æ•°ã‚’è¨ˆç®—ã—ãŸã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’JOINã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

```sql
SELECT
	`simple_blog`.`User`.`id`,
	`simple_blog`.`User`.`name`
FROM
	`simple_blog`.`User`
	LEFT JOIN (
		SELECT `simple_blog`.`Post`.`authorId`, COUNT(*) AS `orderby_aggregator`
		FROM `simple_blog`.`Post`
		WHERE 1=1
		GROUP BY `simple_blog`.`Post`.`authorId`
	) AS `orderby_1_Post`
		ON (`simple_blog`.`User`.`id` = `orderby_1_Post`.`authorId`)
WHERE 1=1
ORDER BY COALESCE(`orderby_1_Post`.`orderby_aggregator`, ?) DESC
LIMIT ? OFFSET ?
```

## ã¾ã¨ã‚

è¦³å¯Ÿã—ãŸçµæœã€ä»¥ä¸‹ã®3ç‚¹ãŒã„ãˆãã†ã§ã™ã€‚

- selectã‚„includeã§ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ã¨ãã¯ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã”ã¨ã«SQLãŒç™ºè¡Œã•ã‚Œã‚‹
    - ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å€‹æ•°ã‚’å–å¾—ã™ã‚‹å ´åˆã¯ä¾‹å¤–ã§ã€countã‚’å–å¾—ã™ã‚‹ã‚¯ã‚¨ãƒªãŒJOINã•ã‚Œã‚‹
- ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§æ¤œç´¢ã™ã‚‹ã¨ãã¯ã€JOINã§ã¯ãªãã‚µãƒ–ã‚¯ã‚¨ãƒªãŒä½¿ã‚ã‚Œã‚‹
- ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚½ãƒ¼ãƒˆã™ã‚‹ã¨ãã¯JOINãŒä½¿ã‚ã‚Œã‚‹

ã¾ãŸã€å–å¾—ãƒ»æ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆã¯ç‹¬ç«‹ã—ã¦è¡Œã‚ã‚Œã¦ã„ãã†ã§ã™ã€‚ã¤ã¾ã‚Šã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®æ¤œç´¢ã¨ã‚½ãƒ¼ãƒˆã‚’åŒæ™‚ã«è¡Œã†å ´åˆã¯ã€ã‚µãƒ–ã‚¯ã‚¨ãƒªã§ã®æ¤œç´¢ã¨JOINã®ä¸¡æ–¹ãŒè¡Œã‚ã‚Œã¾ã™ï¼ˆä¾‹ã¯ï¼Ÿãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çš„ã«ã¯ï¼Ÿï¼‰ã€‚

JOINãŒãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®ã‚½ãƒ¼ãƒˆã‚„ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä»¶æ•°ã®å–å¾—ã«ã—ã‹ä½¿ã‚ã‚Œã¦ã„ãªã„ã®ã¯ã€å°‘ã—æ„å¤–ã§ã—ãŸã€‚

### Prismaã‚’ä½¿ã£ã¦ã„ã¦é­é‡ã—ãã†ãªèª²é¡Œ

æ¤œç´¢ã§æŒ‡å®šã—ãŸæ¡ä»¶ãŒå–å¾—çµæœã«å½±éŸ¿ã‚’ä¸ãˆãªã„ã“ã¨ãŒæ°—ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã€‚ä¾‹ãˆã°ã€UserProfileï¼ˆ-to-oneå´ï¼‰ãŒå­˜åœ¨ã—ãªã„ã¨ã„ã†æ¡ä»¶ã‚’æ›¸ã„ãŸã¨ã—ã¦ã‚‚ã€å–å¾—çµæœã¯UserProfile | nullã«ãªã‚Šã¾ã™ã€‚

ä»–ã«ã¯ã€ï¼ˆå€‹äººçš„ãªå°è±¡ã§ã™ãŒï¼‰é›†è¨ˆã®ã‚¯ã‚¨ãƒªã¯å˜ç´”ãªã‚±ãƒ¼ã‚¹ã§ãªã‘ã‚Œã°Prismaã§ã¯é›£ã—ã„ã®ã‹ãªã¨ã„ã†æ°—ã‚‚ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ã‚±ãƒ¼ã‚¹ã¯ã€pg-typedã‚„sqlcï¼ˆGoï¼‰ãªã©ã®SQLã‹ã‚‰å‹ã‚’ç”Ÿæˆã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå‘ã„ã¦ã„ãã†ã§ã™ï¼ˆNode.js x MySQLã§ã¯ã©ã¡ã‚‰ã‚‚ä½¿ãˆãªã„ã®ã§ç¾¨ã¾ã—ã„â€¦ï¼‰

## å‚è€ƒ

- [Select fields (Concepts)](https://www.prisma.io/docs/concepts/components/prisma-client/select-fields)
- [Relation queries (Concepts)](https://www.prisma.io/docs/concepts/components/prisma-client/relation-queries)
- [Filtering and sorting (Concepts)](https://www.prisma.io/docs/concepts/components/prisma-client/filtering-and-sorting)
