---
title: "Node.jsã®connectã‚’ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ã¦ã¿ã‚‹"
emoji: "ğŸ¤–"
type: "tech"
topics: ["nodejs"]
published: false
---

connectã¯ã€Node.jsã®HTTPã‚µãƒ¼ãƒãƒ¼ã«ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

https://github.com/senchalabs/connect

ã“ã“ã§ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã®å‰ã‚„å¾Œã«å…±é€šå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã‚‚ã®ã®ã“ã¨ã§ã™ã€‚å…·ä½“çš„ã«ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ãŸã‚Šã€ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ãŸã‚Šã—ã¾ã™ã€‚

connectã¯expressã®3ç³»ã¾ã§ä½¿ã‚ã‚Œã¦ã„ã¾ã—ãŸãŒã€4ç³»ã«ãªã£ãŸã¨ãã«expressã‹ã‚‰å‰Šé™¤ã•ã‚ŒãŸã‚ˆã†ã§ã™ã€‚ä»Šå›ã¯connectã®3.7.0ã‚’èª­ã¿ã¾ã—ãŸã€‚[senchalabs/connect at 3.7.0](https://github.com/senchalabs/connect/tree/3.7.0)

## connectã‚’ä½¿ã£ã¦ã¿ã‚‹

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸã‚‰`Hello, world`ã‚’è¿”ã™HTTPã‚µãƒ¼ãƒãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’2ã¤ã¨ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«æ›¸ãè¾¼ã‚€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®åˆè¨ˆ3ã¤ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

```js:playground/index.js
const connect = require("connect")

const app = connect();
app.use(function(req, res, next) {
  console.log('middleware 1');
  next();
});

app.use(function(req, res, next) {
  console.log('middleware 2');
  next();
});

app.use(function(req, res) {
  res.end("Hello, world!")
})

app.listen(3000);
```

```
$ node playground/index.js
# åˆ¥ã®ç«¯æœ«ã§curlã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹
middleware 1
middleware 2

$ curl localhost:3000
Hello, world!
```

## èª­ã‚“ã§ã¿ã‚‹

### ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ

connectã¯å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚`require`ã§èª­ã¿è¾¼ã¾ã‚Œã‚‹ã®ã¯ã€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã®`index.js`ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹`createServer`ã§ã™ã€‚

`createServer`ã§ã¯ã€`app`ã¨ã„ã†é–¢æ•°ã‚’å®šç¾©ã—ãŸå¾Œã€`app`ã«ã„ãã¤ã‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

```js:index.js
// é–¢ä¿‚ãªã•ãã†ãªã¨ã“ã‚ã¯çœç•¥
module.exports = createServer;

var finalhandler = require('finalhandler');
var http = require('http');
var merge = require('utils-merge');
var proto = {};

function createServer() {
  function app(req, res, next){ app.handle(req, res, next); }
  merge(app, proto);
  merge(app, EventEmitter.prototype);
  app.route = '/';
  app.stack = [];
  return app;
}
```

`app.handle`ã®`handle`ã¯ã€å¾Œã‚ã®ã‚³ãƒ¼ãƒ‰ã§`proto`ã«è¿½åŠ ã•ã‚Œã¦ã„ã¦ã€ãã‚ŒãŒ`merge(app, proto)`ã§`app`ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚ã€Œ`app`ã®ä¸­ã§`app`ã‚’å‚ç…§ã§ãã‚‹ã®ã‹ï¼Ÿã€ã¨æ€ã„ã¾ã—ãŸãŒã€å†å¸°é–¢æ•°ã‚’æ›¸ãã¨ãã‚‚ãã†ã—ã¦ã„ãŸã“ã¨ã‚’æ€ã„å‡ºã—ã¦ç´å¾—ã—ã¾ã—ãŸã€‚

### app.use(fn)

`app.use`ã¯ã€æ¸¡ã—ãŸãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’`stack`ã¨ã„ã†é…åˆ—ã«è¿½åŠ ã—ã¾ã™ã€‚

```js:index.js
proto.use = function use(route, fn) {
  var handle = fn;
  var path = route;

  // default route to '/'
  if (typeof route !== 'string') {
    handle = route;
    path = '/';
  }

  // çœç•¥

  // add the middleware
  debug('use %s %s', path || '/', handle.name || 'anonymous');
  this.stack.push({ route: path, handle: handle });

  return this;
};
```

`use`ã§ã¯ç¬¬ä¸€å¼•æ•°ã«ãƒ‘ã‚¹ã‚’æŒ‡å®šã§ãã¾ã™ãŒã€ã‚ã¾ã‚Šä½¿ã‚ãªã•ãã†ãªæ©Ÿèƒ½ã ã£ãŸã®ã§ä»Šå›ã¯èª­ã¿é£›ã°ã—ã¾ã—ãŸã€‚

### app.listen([â€¦])

`http.createServer`ã§HTTPã‚µãƒ¼ãƒãƒ¼ã‚’ä½œæˆã—ã¦ã€`listen`ã§æ¥ç¶šå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚

```js:index.js
proto.listen = function listen() {
  var server = http.createServer(this);
  return server.listen.apply(server, arguments);
};
```

`http.createServer`ã«ã¯ã€[requestã‚¤ãƒ™ãƒ³ãƒˆ](https://nodejs.org/api/http.html#event-request)ã«ç´ä»˜ã‘ã‚‰ã‚Œã‚‹ãƒªã‚¹ãƒŠãƒ¼ã‚’æ¸¡ã—ã¾ã™ã€‚thisã¯å‘¼ã³å‡ºã•ã‚ŒãŸé–¢æ•°ãŒå±ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‚’è¡¨ã™ã®ã§ã€ã“ã®å ´åˆã¯appé–¢æ•°ã®ã“ã¨ã§ã™ã€‚

æ¬¡ã®è¡Œã¯è¦‹æ…£ã‚Œãªã„å‡¦ç†ã§ã—ãŸãŒã€ã“ã‚Œã¯`server.listen(arguments)`ã¨ã»ã¼åŒã˜ã§ã™ã€‚å¯å¤‰é•·å¼•æ•°ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«`Function.prototype.apply`ãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚

`app`ã®ä¸­ã§ã¯`app.handle`ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã®ã§ã€æ¬¡ã¯`app.handle`ã‚’èª­ã¿ã¾ã™ã€‚

### app.handle

ã“ã“ãŒconnectã®ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†ã§ã™ã€‚`handle`ã§ã¯ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’é †ç•ªã«å®Ÿè¡Œã—ã¾ã™ã€‚finalhandlerã¯ã€ã‚¨ãƒ©ãƒ¼ã®å†…å®¹ã«å¿œã˜ãŸã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

```js:index.js
// ãƒ‘ã‚¹ã«é–¢ã™ã‚‹ã¨ã“ã‚ã¯çœç•¥
proto.handle = function handle(req, res, out) {
  var index = 0;
  var stack = this.stack;

  // final function handler
  var done = out || finalhandler(req, res, {
    env: env,
    onerror: logerror
  });

  function next(err) {
    // next callback
    var layer = stack[index++];

    // all done
    if (!layer) {
      defer(done, err);
      return;
    }

    // route data
    var path = parseUrl(req).pathname || '/';
    var route = layer.route;

    // call the layer handle
    call(layer.handle, route, err, req, res, next);
  }

  next();
};
```

`handle`ã®ä¸­ã§ã¯ã€`next`ã¨ã„ã†ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’å‘¼ã³å‡ºã—ã¦ãƒã‚¤ãƒ³ã‚¿ã‚’é€²ã‚ã‚‹é–¢æ•°ã‚’ä½œæˆã—ã€`call`ã«`next`ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ä¸­ã§`next`ã‚’å®Ÿè¡Œã™ã‚‹ã®ã§ã€ã¡ã‚‡ã£ã¨åˆ†ã‹ã‚Šã«ãã„ã§ã™ãŒã“ã‚Œã¯å†å¸°é–¢æ•°ã«ãªã£ã¦ã„ã¾ã™ã€‚

### call

`call`ã¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å®Ÿè¡Œã‚’æ‹…å½“ã™ã‚‹é–¢æ•°ã§ã™ã€‚`Function.prototype.length`ã§å¼•æ•°ã®å€‹æ•°ã‚’å–å¾—ã—ã€4å€‹ã‹ãã‚Œæœªæº€ã‹ã©ã†ã‹ã§åˆ†å²ã—ã¦ã„ã¾ã™ã€‚å¼•æ•°ãŒ4å€‹ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ã€ã‚¨ãƒ©ãƒ¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ã„ã†ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ‹…å½“ã™ã‚‹ç‰¹åˆ¥ãªãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã™ã€‚

```js:index.js
function call(handle, route, err, req, res, next) {
  var arity = handle.length;
  var error = err;
  var hasError = Boolean(err);

  debug('%s %s : %s', handle.name || '<anonymous>', route, req.originalUrl);

  try {
    if (hasError && arity === 4) {
      // error-handling middleware
      handle(err, req, res, next);
      return;
    } else if (!hasError && arity < 4) {
      // request-handling middleware
      handle(req, res, next);
      return;
    }
  } catch (e) {
    // replace the error
    error = e;
  }

  // continue
  next(error);
}
```

ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ãªã„å ´åˆã¯ã€`app.handle()`â†’`next()`â†’1ã¤ç›®ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒå®Ÿè¡Œâ†’1ã¤ç›®ã®ä¸­ã§`next()`â†’2ã¤ç›®ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒå®Ÿè¡Œâ†’2ã¤ç›®ã®ä¸­ã§`next()`â†’â€¦ã¨ã„ã†ã‚ˆã†ã«ã€é€šå¸¸ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒã™ã¹ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã®å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚

â–¡ãŒæ™®é€šã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã€â– ãŒã‚¨ãƒ©ãƒ¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã™ã€‚

![](https://i.gyazo.com/b28350cb5c3f64838191deb9b6082200.jpg)

ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å®Ÿè¡Œã§ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€`next(error)`ãŒå®Ÿè¡Œã•ã‚Œã€ä¸€ç•ªè¿‘ãã«ã‚ã‚‹ã‚¨ãƒ©ãƒ¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å®Ÿè¡ŒãŒç¶šãã‹ã©ã†ã‹ã¯ã€ã‚¨ãƒ©ãƒ¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ä¸­ã§`next()`ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã«ã‚ˆã‚Šã¾ã™ã€‚

ã‚¨ãƒ©ãƒ¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã¯ã€å¾Œç¶šã®ã‚¨ãƒ©ãƒ¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«å¼•ãç¶™ããŸã‚ã«`next(err)`ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã€nextã‚’å®Ÿè¡Œã—ãªã„ã‹ã®ã©ã¡ã‚‰ã‹ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

![](https://i.gyazo.com/0f92bb297e73f629d326d13c9fea89b6.jpg)

## ã¾ã¨ã‚

- connectã¯ã€HTTPã‚µãƒ¼ãƒãƒ¼ã«ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å¼•æ•°ã®`next`ã¯ã€è‡ªèº«ä»¥é™ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’å†å¸°çš„ã«å‘¼ã³å‡ºã™é–¢æ•°
  - ã¤ã¾ã‚Šã€`next()`ä»¥é™ã«æ›¸ã„ãŸå‡¦ç†ã¯ã€ä»¥é™ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å®Ÿè¡ŒãŒå®Œäº†ã—ã¦ã‹ã‚‰å®Ÿè¡Œã•ã‚Œã‚‹
- connectã®å¼•æ•°ãŒ4å€‹ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å®Ÿè¡Œã§ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸã¨ãã ã‘å‘¼ã³å‡ºã•ã‚Œã‚‹ç‰¹åˆ¥ãªãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

`next`ã‚’ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å¼•æ•°ã«æ¸¡ã™ã¨ã“ã‚ãŒç†è§£ã—ã¥ã‚‰ã‹ã£ãŸã®ã§ã€ãã®éƒ¨åˆ†ã ã‘è‡ªåˆ†ã§æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚

https://github.com/tekihei2317/playground/tree/main/middleware-pattern
