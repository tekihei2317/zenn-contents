---
title: "Prismaã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ï¼ˆClient extensionsã‚‚ä½¿ã£ã¦ã¿ã‚‹ï¼‰"
emoji: "ğŸ•"
type: "tech"
topics: ["prisma", "nodejs"]
published: false
---

Prismaã§ãƒšãƒ¼ã‚¸ç•ªå·ãƒ™ãƒ¼ã‚¹ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚ã¾ãŸã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹å‡¦ç†ã‚’Prisma Client extensionsã§å…±é€šåŒ–ã—ã¦ã¿ã¾ã—ãŸã€‚

## ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹

Prismaã®`findMany`ã«ã¯ã€SQLã®OFFSETã¨LIMITã«å¯¾å¿œã™ã‚‹`skip`ã¨`take`ãŒã‚ã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€ãƒšãƒ¼ã‚¸ç•ªå·ãƒ™ãƒ¼ã‚¹ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã§ãã¾ã™ã€‚åˆè¨ˆãƒšãƒ¼ã‚¸æ•°ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆå´ã§æ¬²ã—ã„ãŸã‚è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚

```ts
async function getPosts(input: { page: number }) {
  const perPage = 10
  const skip = perPage * (input.page - 1)
  const where: Prisma.PostWhereInput = { authorId: 1 }

  const [posts, postCount] = await Promise.all([
    prisma.post.findMany({
      where,
      orderBy: { createdAt: 'desc' },
      skip,
      take: perPage,
    }),
    prisma.post.count({ where }),
  ])
  const pageCount = Math.ceil(postCount / perPage)

  return { items: posts, count: postCount, pageCount }
}
```

å‚è€ƒ: [Pagination (Reference)](https://www.prisma.io/docs/concepts/components/prisma-client/pagination)

ä¸Šã®å®Ÿè£…ã«ã¯ã€æ”¹å–„ã—ãŸã„ã¨ã“ã‚ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚

- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»–ã§ã‚‚å®Ÿè£…ã™ã‚‹å ´åˆã€`offset`ã‚„`pageCount`ã‚’è¨ˆç®—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒè¤‡æ•°ã®ç®‡æ‰€ã«æ›¸ã‹ã‚Œã¦ã—ã¾ã†
- è¿”å´ã™ã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å½¢å¼ãŒãƒãƒ©ãƒãƒ©ã«ãªã£ã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚‹ï¼ˆä¾‹ãˆã°ã€`pageCount`ãŒ`totalPages`ã«ãªã£ã¦ã—ã¾ã†ï¼‰

ãã®ãŸã‚ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®é–¢æ•°ã‚’ä½œã£ã¦å…±é€šåŒ–ã—ã¾ã™ã€‚Blitz.jsã®`paginate`é–¢æ•°ã®APIï¼ˆ[usePaginatedQuery - Blitz.js](https://blitzjs.com/docs/use-paginated-query)ï¼‰ã‚’å‚è€ƒã«ä½œã‚Šã¾ã—ãŸã€‚



```ts
type PaginateInputs<Items> = {
  page: number
  perPage: number
  queryFn: (args: { skip: number; take: number }) => Promise<Items>
  countFn: () => Promise<number>
}

type PaginateOutputs<Items> = {
  items: Items
  count: number
  pageCount: number
}

/**
 * ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
 */
export async function paginate<Items>({
  page,
  perPage,
  countFn,
  queryFn,
}: PaginateInputs<Items>): Promise<PaginateOutputs<Items>> {
  const [items, count] = await Promise.all([
    queryFn({
      skip: perPage * (page - 1),
      take: perPage,
    }),
    countFn(),
  ])

  return {
    items,
    count,
    pageCount: Math.ceil(count / perPage),
  }
}
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ãˆã¾ã™ã€‚

```ts
async function getPosts(input: { page: number }) {
  const where: Prisma.PostWhereInput = { authorId: 1 }

  return await paginate({
    page: input.page,
    perPage: 10,
    queryFn: (args) =>
      prisma.post.findMany({
        where,
        orderBy: { createdAt: 'desc' },
        skip,
        take: perPage,
      }),
    countFn: () => prisma.post.count({ where })
  })
}
```

ã²ã¨ã¾ãšä¸Šè¨˜ã®èª²é¡Œã¯è§£æ±ºã§ãã¾ã—ãŸã€‚ã—ã‹ã—ã€`where`ã‚’2å›æ›¸ã„ã¦ã„ã‚‹ã®ã§ã€ä¸€åº¦ã ã‘ï¸æ›¸ãã‚ˆã†ã«ã—ãŸã„ã§ã™ã€‚ã¾ãŸã€`queryFn`ãŒè¤‡é›‘ã«ãªã‚‹ã¨ã€ãƒã‚¹ãƒˆãŒæ·±ã„ãŸã‚å°‘ã—èª­ã¿ã¥ã‚‰ããªã‚‹ã®ã‚‚æ°—ã«ãªã‚Šã¾ã™ã€‚
## prismaã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¦‹ã¦ã¿ã‚‹

prismaã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ¢ã—ã¦ã¿ã‚‹ã¨ã€2ã¤è¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã“ã‚Œã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ãˆã°å•é¡Œã‚’è§£æ±ºã§ããã†ã§ã—ãŸã€‚

- [prisma-pagination - npm](https://www.npmjs.com/package/prisma-pagination)
- [prisma-paginate - npm](https://www.npmjs.com/package/prisma-paginate)

```ts
// prisma-pagination
async function getPosts(input: { page: number }) {
  const paginate = createPaginator({ perPage: 10 })

  return await paginate<User, Prisma.UserFindManyArgs>(
    prisma.user,
    {
      where: { authorId: 1 },
      orderBy: { createdAt: 'desc' },
    },
    { page: input.page },
  )
}
```

```ts
// prisma-paginate
import prismaPaginate from "prisma-paginate";

async function getPosts(input: { page: number }) {
  return await paginate(prisma.post)(
    {
      where: { authorId: 1 },
      orderBy: { createdAt: 'desc' },
    },
    { page: 1, limit: 10 },
  );
}
```

è‡ªä½œã®`paginate`é–¢æ•°ã‚ˆã‚Šã‚‚ç°¡æ½”ã«æ›¸ã‘ã¾ã™ã€‚ã—ã‹ã—ã€ã“ã‚Œã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¯èª²é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚ãã‚Œã¯ã€`findMany`ã®æˆ»ã‚Šå€¤ã‚’å¼•æ•°ã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«å¤‰ãˆã‚‰ã‚Œãªã„ã“ã¨ã§ã™ã€‚

ä¾‹ãˆã°ã€`findMany`ã§`{ select: { id: 1 } }`ã®ã‚ˆã†ã«å–å¾—ã™ã‚‹ã‚«ãƒ©ãƒ ã‚’æŒ‡å®šã—ãŸå ´åˆã€`prisma-pagination`ã§ã¯ã€ãã‚Œã«åˆã‚ã›ã¦ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€`prisma-paginate`ã§ã¯ãƒ¢ãƒ‡ãƒ«å…¨ä½“ã‚’è¿”ã™ã“ã¨ã«ãªã£ã¦ã—ã¾ã£ã¦ã„ã¾ã—ãŸã€‚

ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã«tRPCã‚’ä½¿ã£ã¦ãŠã‚Šã€APIãŒè¿”ã—ãŸå‹ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã§ã‚‚ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ã“ã‚Œã¯é‡è¦ãªå•é¡Œã§ã—ãŸã€‚

Prismaã®`findMany`ã®å‹ã‚’å‚è€ƒã«é ‘å¼µã£ã¦è‡ªä½œã™ã‚Œã°è§£æ±ºã§ããã†ãªæ°—ãŒã—ã¾ã—ãŸãŒã€Prisma Client extensionsã‚’ä½¿ã£ã¦è§£æ±ºã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

## Prisma Client extensionsã‚’ä½¿ã†

Prisma Client extensionsã¯ã€ãã®åã®é€šã‚ŠPrisma Clientã‚’æ‹¡å¼µã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã§ã™ã€‚Prisma 4.7ã‹ã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã¨ã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

[Prisma Client extensions (Preview)](https://www.prisma.io/docs/concepts/components/prisma-client/client-extensions)

Client extensionsã«ã¯ã€ãƒ¢ãƒ‡ãƒ«ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã™ã‚‹æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹ã¨`user`ãƒ¢ãƒ‡ãƒ«ã«`signUp`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã§ãã¾ã™ã€‚

```ts
export const xprisma = prisma.$extends({
  model: {
    user: {
      async signUp(email: string) {
        await prisma.user.create({ data: { email } });
      },
    },
  }
})

xprisma.user.signUp('test@example.com')
```

ã¾ãŸã€`$allModels`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ã†ã¨ã€å…¨ã¦ã®ãƒ¢ãƒ‡ãƒ«ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã§ãã¾ã™ã€‚prisma 4.9.0ã‹ã‚‰`$allModels`ã«å¯¾ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®å…¥å‡ºåŠ›ã«å³å¯†ãªå‹ãŒã¤ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸãŸã‚ã€å®Ÿç”¨çš„ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

[Prisma Client extensions: model component (Preview)](https://www.prisma.io/docs/concepts/components/prisma-client/client-extensions/model#advanced-type-safety-improve-the-type-safety-and-developer-experience-of-your-custom-model-methods)

```ts
export const xprisma = prisma.$extends({
  model: {
    $allModels: {
      async paginate<T, A>(
        this: T,
        args: Prisma.Exact<A, Prisma.Args<T, "findMany">> & {
          page: number;
          perPage: number;
        }
      ): Promise<Prisma.Result<T, A, "findMany">> {
        const { page, perPage } = args;

        return await (this as any).findMany({
          // omitã®å®Ÿè£…ã¯çœç•¥
          ...omit(args, "page", "perPage"),
          skip: perPage * (page - 1),
          take: perPage,
        });
      },
    },
  },
});

async function getPosts(input: { page: number }) {
  return await xprisma.post.paginate({
    page: input.page,
    perPage: 10,
    where: { authorId: 1 },
    orderBy: { createdAt: 'desc' },
  })
}
```

ç¬¬ä¸€å¼•æ•°ã®`this: T`ã¯ã€é–¢æ•°ã‚’å‘¼ã³å‡ºã—ãŸã¨ãã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å‹ã‚’ã¤ã‘ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã€å®Ÿè¡Œã™ã‚‹ã¨ãã«æ¸¡ã™å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

[TypeScript: Documentation - Declaring this in a Function](https://www.typescriptlang.org/docs/handbook/2/functions.html#declaring-this-in-a-function)


ä¾‹ãˆã°ã€`xprisma.post.paginate`ã¨å®Ÿè¡Œã™ã‚‹ã¨ã€`T`ã¯`typeof prisma.post`ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã«å¯¾ã—ã€`Prisma.Args`ã‚„`Prisma.Result`ãªã©ã®å‹ã‚’ä½¿ã£ã¦å…¥å‡ºåŠ›ã«å‹ã‚’ã¤ã‘ã¦ã„ã¾ã™ã€‚ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã§ã‚‚å•é¡Œãªãè£œå®Œã‚„å‹ãƒã‚§ãƒƒã‚¯ãŒã§ãã¾ã—ãŸã€‚

## ã¾ã¨ã‚

Prismaã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…±é€šåŒ–ã™ã‚‹æ–¹æ³•ã‚’è€ƒãˆã¾ã—ãŸã€‚æœ€åˆã®Blitz.jsã‚’å‚è€ƒã«ã—ãŸæ–¹æ³•ã¯ã€æ­£ç¢ºã«å‹ãŒã¤ã‘ã‚‰ã‚Œã‚‹ã‚‚ã®ã®è¨˜è¿°ãŒå°‘ã—å†—é•·ã§ã—ãŸã€‚ã¾ãŸã€prisma-paginateãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ–¹æ³•ã§ã¯ã€è¨˜è¿°ã¯ç°¡æ½”ã«ãªã‚‹ã‚‚ã®ã®ã€å¼•æ•°ã«ã‚ˆã£ã¦æˆ»ã‚Šå€¤ã®å‹ãŒå¤‰åŒ–ã™ã‚‹ã“ã¨ã«å¯¾å¿œã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

ã“ã‚Œã‚‰ã®å•é¡Œã¯ã€Prisma Client extensionsã‚’ä½¿ã£ã¦è§£æ±ºã§ãã¾ã—ãŸã€‚

## å‚è€ƒ

- [Prisma Client extensions (Preview)](https://www.prisma.io/docs/concepts/components/prisma-client/client-extensions)
- [Prisma Client extensions: model component (Preview)](https://www.prisma.io/docs/concepts/components/prisma-client/client-extensions/model)
