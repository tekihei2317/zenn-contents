---
title: "Prismaã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ï¼ˆClient extensionsã‚‚ä½¿ã£ã¦ã¿ã‚‹ï¼‰"
emoji: "ğŸ•"
type: "tech"
topics: ["prisma", "nodejs"]
published: false
---

Prismaã§ãƒšãƒ¼ã‚¸ç•ªå·ãƒ™ãƒ¼ã‚¹ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚ã¾ãŸã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹å‡¦ç†ã‚’Prisma Client extensionsã§å…±é€šåŒ–ã—ã¦ã¿ã¾ã—ãŸã€‚

## ã¾ãšã¯æ›¸ã„ã¦ã¿ã‚‹

Prismaã®findManyã«ã¯ã€SQLã®OFFSETã¨LIMITã«å¯¾å¿œã™ã‚‹skipã¨takeãŒã‚ã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€ãƒšãƒ¼ã‚¸ç•ªå·ãƒ™ãƒ¼ã‚¹ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã§ãã¾ã™ã€‚åˆè¨ˆãƒšãƒ¼ã‚¸æ•°ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆå´ã§æ¬²ã—ã„ãŸã‚è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚

```ts
const perPage = 10
const skip = perPage * (input.page - 1)
const where: Prisma.PostWhereInput = { authorId: 1 }

const [posts, postCount] = await Promise.all([
  prisma.post.findMany({
    where,
    orderBy: { createdAt: 'desc' },
    skip,
    take: perPage,
  }),
  prisma.post.count({ where }),
])
const pageCount = Math.ceil(postCount / perPage)

return { items: posts, count: postCount, pageCount }
```

å‚è€ƒ: [Pagination (Reference)](https://www.prisma.io/docs/concepts/components/prisma-client/pagination)

ä¸Šã®å®Ÿè£…ã«ã¯ã€æ”¹å–„ã—ãŸã„ã¨ã“ã‚ãŒ2ã¤ã‚ã‚Šã¾ã™ã€‚

- offsetã‚„pageCountã‚’è¨ˆç®—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒè¤‡æ•°ã®ç®‡æ‰€ã«æ›¸ã‹ã‚Œã¦ã—ã¾ã†
- è¿”å´ã™ã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å½¢å¼ãŒãƒãƒ©ãƒãƒ©ã«ãªã£ã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚‹ï¼ˆä¾‹ãˆã°ã€pageCountãŒtotalPagesã«ãªã‚‹ï¼‰

ãã®ãŸã‚ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®é–¢æ•°ã‚’ä½œã£ã¦å…±é€šåŒ–ã—ã¾ã—ãŸã€‚Blitzã®APIã‚’å‚è€ƒã«paginateé–¢æ•°ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

```ts
type PaginateInputs<Items> = {
  page: number
  perPage: number
  queryFn: (args: { skip: number; take: number }) => Promise<Items>
  countFn: () => Promise<number>
}

type PaginateOutputs<Items> = {
  items: Items
  count: number
  pageCount: number
}

/**
 * ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
 */
export async function paginate<Items>({
  page,
  perPage,
  countFn,
  queryFn,
}: PaginateInputs<Items>): Promise<PaginateOutputs<Items>> {
  const [items, count] = await Promise.all([
    queryFn({
      skip: perPage * (page - 1),
      take: perPage,
    }),
    countFn(),
  ])

  return {
    items,
    count,
    pageCount: Math.ceil(count / perPage),
  }
}
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ãˆã¾ã™ã€‚

```ts
const where: Prisma.PostWhereInput = { authorId: 1 }

return await paginate({
  page: input.page,
  perPage: 10,
  queryFn: (args) =>
    prisma.post.findMany({
      where,
      orderBy: { createdAt: 'desc' },
      skip,
      take: perPage,
    }),
  countFn: () => prisma.post.count({ where })
})
```

## prisma-paginationã‚’å‚è€ƒã«ã™ã‚‹

`where`ã‚’2å›æ›¸ã„ã¦ã„ã‚‹ã®ã§ã€ä¸€åº¦ã ã‘ï¸æ›¸ãã‚ˆã†ã«ã—ãŸã„ã§ã™ã€‚

prisma paginationã§æ¤œç´¢ã™ã‚‹ã¨ã€2ã¤ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚

- [prisma-pagination - npm](https://www.npmjs.com/package/prisma-pagination)
- [prisma-paginate - npm](https://www.npmjs.com/package/prisma-paginate)

```ts
// prisma-pagination
const paginate = createPaginator({ perPage: 10 })

const result = await paginate<User, Prisma.UserFindManyArgs>(
  prisma.user,
  { orderBy: { id: 'desc' } },
  { page: query.page },
})

// prisma-paginate
import { PrismaClient } from "@prisma/client";
import prismaPaginate from "prisma-paginate";

const prisma = new PrismaClient();

const result = await paginate(prisma.post)(
  { where: { authorId: 1 },
  { page: 1, limit: 10 }
);
```

ä¸Šè¨˜ã§ä½œã£ãŸé–¢æ•°ã‚ˆã‚Šã‚‚ç°¡æ½”ã«æ›¸ã‘ã¾ã™ã€‚ã—ã‹ã—ã€ã“ã‚Œã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¯èª²é¡ŒãŒã‚ã‚Šã—ãŸã€‚ãã‚Œã¯ã€findManyã®æˆ»ã‚Šå€¤ã‚’å¼•æ•°ã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«å¤‰ãˆã‚‰ã‚Œãªã„ã“ã¨ã§ã™ã€‚ä¾‹ãˆã°ã€`{ select: { id: 1 } }`ã®ã‚ˆã†ã«å–å¾—ã™ã‚‹ã‚«ãƒ©ãƒ ã‚’æŒ‡å®šã—ãŸå ´åˆã§ã‚‚ã€ãƒ¢ãƒ‡ãƒ«å…¨ä½“ã‚’è¿”ã™ã“ã¨ã«ãªã£ã¦ã—ã¾ã£ã¦ã„ã¾ã—ãŸã€‚

Prismaã®`findMany`ã®å‹ã‚’å‚è€ƒã«é ‘å¼µã‚Œã°è§£æ±ºã§ããã†ãªæ°—ãŒã—ã¾ã—ãŸãŒã€Prisma Client extensionsã‚’ä½¿ã£ã¦è§£æ±ºã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

## Prisma Client extensionsã‚’ä½¿ã†

Prisma Client extensionsã¯ã€ãã®åã®é€šã‚ŠPrisma Clientã‚’æ‹¡å¼µã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã§ã™ã€‚Prisma 4.7ã‹ã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã¨ã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

Client extensionsã«ã¯ã€ãƒ¢ãƒ‡ãƒ«ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã™ã‚‹æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ä»¥ä¸‹ã®ä¾‹ãŒã‚ã‚Šã¾ã™ã€‚

```ts
export const xprisma = prisma.$extends({
  model: {
    user: {
      async signUp(email: string) {
        await prisma.user.create({ data: { email } });
      },
    },
  }
})

xprisma.user.signUp('test@example.com')
```

ã¾ãŸã€`$allModels`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ã†ã¨ã€å…¨ã¦ã®ãƒ¢ãƒ‡ãƒ«ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã§ãã¾ã™ã€‚prismaã®4.9.0ã§$allModelsã«å¯¾ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚‚ãã¡ã‚“ã¨å‹ãŒã¤ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸãŸã‚ã€å®Ÿç”¨çš„ã«ä½¿ãˆãã†ã§ã™ã€‚

ã“ã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã€paginateãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

```ts
export const xprisma = prisma.$extends({
  model: {
    $allModels: {
      async paginate<T, A>(
        this: T,
        args: Prisma.Exact<A, Prisma.Args<T, "findMany">> & {
          page: number;
          perPage: number;
        }
      ): Promise<Prisma.Result<T, A, "findMany">> {
        const { page, perPage } = args;

        return await (this as any).findMany({
          ...omit(args, "page", "perPage"),
          skip: perPage * (page - 1),
          take: perPage,
        });
      },
    },
  },
});
```

ç¬¬ä¸€å¼•æ•°ã®this: Tã¯ã€é–¢æ•°ã‚’å‘¼ã³å‡ºã—ãŸã¨ãã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã€å®Ÿè¡Œã™ã‚‹ã¨ãã«æ¸¡ã™å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¾‹ãˆã°ã€`xprisma.user.paginate`ã¨å®Ÿè¡Œã™ã‚‹ã¨ã€Tã¯`typeof prisma.user`ã«ãªã‚Šã¾ã™ã€‚

[TypeScript: Documentation - Declaring this in a Function](https://www.typescriptlang.org/docs/handbook/2/functions.html#declaring-this-in-a-function)


ã“ã‚Œã«å¯¾ã—ã€`Prisma.Args`ã‚„`Prisma.Result`ãªã©ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦å…¥å‡ºåŠ›ã«å‹ã‚’ã¤ã‘ã¦ã„ã¾ã™ã€‚

## ã¾ã¨ã‚

Prismaã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…±é€šåŒ–ã™ã‚‹æ–¹æ³•ã‚’è€ƒãˆã¾ã—ãŸã€‚æœ€åˆã®Blitzé¢¨ã®æ–¹æ³•ã¯ã€æ­£ç¢ºã«å‹ãŒã¤ã‘ã‚‰ã‚Œã‚‹ã‚‚ã®ã®è¨˜è¿°ãŒå°‘ã—å†—é•·ã§ã—ãŸã€‚ã¾ãŸã€prisma-paginateãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ–¹æ³•ã§ã¯ã€è¨˜è¿°ã¯ç°¡æ½”ã«ãªã‚‹ã‚‚ã®ã®ã€å¼•æ•°ã«ã‚ˆã£ã¦æˆ»ã‚Šå€¤ã®å‹ãŒå¤‰åŒ–ã™ã‚‹ã“ã¨ã«å¯¾å¿œã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

Prisma Client extensionsã‚’ä½¿ã†ã¨ã€ã“ã‚Œã‚‰ã®å•é¡Œã‚’è§£æ±ºã§ãã¾ã—ãŸã€‚

## å‚è€ƒ

- Client extensionsã«ã¤ã„ã¦
- Client extensionsã®å‹ãŒå¼·åŒ–ã•ã‚ŒãŸã“ã¨ã«ã¤ã„ã¦
- Blitzã®API
