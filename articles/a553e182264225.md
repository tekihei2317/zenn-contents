---
title: "Prismaã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½œã‚‹"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["prisma", "nodejs", "typescript"]
published: true
publication_name: "gibjapan"
---

## èƒŒæ™¯

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å­˜åœ¨ã™ã‚‹ã“ã¨ï¼ˆã—ãªã„ã“ã¨ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸã„ã¨ããŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚’ã™ã‚‹ã¨ãã«ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒé‡è¤‡ã—ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã—ãŸã„ã¨ã—ã¾ã™ã€‚Prismaã§æ„šç›´ã«å®Ÿè£…ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

```ts
async function isUserNameUnique(prisma: PrismaClient, userName: string): Promise<boolean> {
  const user = await prisma.user.findFirst({ where: { userName } });
  return user !== null;
}
```
ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒã‚§ãƒƒã‚¯ã‚’ã™ã‚‹ç®‡æ‰€ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã€ã“ã®ã‚ˆã†ãªé–¢æ•°ã‚’ä½•åº¦ã‚‚å®šç¾©ã™ã‚‹ã®ã¯å°‘ã—é¢å€’ã§ã™ã€‚

ã¨ã“ã‚ã§ã€Laravelã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯`unique`ã‚„`exists`ãªã©ã®ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã€ä¸€æ„æ€§ã‚„å­˜åœ¨ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç°¡æ½”ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```php
$request->validate([
    // user_nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ãŒã€usersãƒ†ãƒ¼ãƒ–ãƒ«ã®user_nameã‚«ãƒ©ãƒ ã«å­˜åœ¨ã—ãªã„ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹
    'user_name' => 'unique:users'
]);
```

[ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ 9.x Laravel](https://readouble.com/laravel/9.x/ja/validation.html)

Prismaã§ã‚‚Laravelã®ã‚ˆã†ã«æ›¸ããŸã‹ã£ãŸã®ã§ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒã‚§ãƒƒã‚¯ã‚’ç°¡æ½”ã«æ›¸ããŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

## ä½œã£ãŸã‚‚ã®

`modelValidator`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œã‚Šã¾ã—ãŸã€‚

```ts
const userValidator = modelValidator(prisma.user);

async function createUser(userName: string) {
  // ç™»éŒ²ã™ã‚‹ã¨ã
  const isUserNameUnique = await userValidator.isUnique({ userName })
}

async function updateUserName(userId: number, userName: string) {
  // æ›´æ–°ã™ã‚‹ã¨ãï¼ˆè‡ªåˆ†è‡ªèº«ã¯é™¤å¤–ã™ã‚‹ï¼‰
  const isUserNameUnique = await userVaidator.isUnique({ userName }, { id: userId })
}
```

ã“ã®ä¾‹ã®å ´åˆã€`isUnique`ã®ç¬¬1å¼•æ•°ã¯`UserWhereInput`ã§ã€ç¬¬2å¼•æ•°ã¯`UserWhereUniqueInput`ã§ã™ã€‚æ›´æ–°ã™ã‚‹ã¨ãã¯è‡ªåˆ†è‡ªèº«ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒã‚§ãƒƒã‚¯ã‹ã‚‰é™¤å¤–ã—ãŸã„ã®ã§ã€é™¤å¤–ã™ã‚‹ã‚‚ã®ã‚’ç¬¬2å¼•æ•°ã§æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

### å®Ÿè£…ï¼ˆå‹ï¼‰

`isUnique`ã®å¼•æ•°ã®å‹ã¯ã€`findFirst`ã¨`findUnique`ã®å¼•æ•°ã®`where`ã‹ã‚‰å–å¾—ã—ã¦ã„ã¾ã™ã€‚

```ts
type PrismaModel = {
  findFirst: (...args: any[]) => Promise<any>
  findUnique: (...args: any[]) => Promise<any>
}

type ModelWhereInput<Model extends PrismaModel> = NonNullable<NonNullable<Parameters<Model['findFirst']>[0]>['where']>
type ModelWhereUniqueInput<Model extends PrismaModel> = NonNullable<
  NonNullable<Parameters<Model['findUnique']>[0]>['where']
>

type UniqueValidator<Model extends PrismaModel> = (
  fields: ModelWhereInput<Model>,
  ignore?: ModelWhereUniqueInput<Model>
) => Promise<boolean>

type ModelValidator<Model extends PrismaModel> = {
  isUnique: UniqueValidator<Model>
}
```

`findFirst`ã®ã‚·ã‚°ãƒãƒãƒ£ã¯ã“ã‚“ãªæ„Ÿã˜ãªã®ã§ã€`NonNullable`ã§`undefined`ã‚’é™¤å¤–ã—ãªãŒã‚‰ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

```ts
(args?: { where?: ModelWhereInput }) => (çœç•¥)
```

### å®Ÿè£…ï¼ˆé–¢æ•°ï¼‰

`findFirst`ã§ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã€é™¤å¤–ã™ã‚‹å¯¾è±¡ãŒã‚ã‚‹å ´åˆã¯ãã®å‡¦ç†ã‚’ã—ã¦ã„ã¾ã™ã€‚

```ts
function createUniqueValidator<Model extends PrismaModel>(model: Model): UniqueValidator<Model> {
  const validator: UniqueValidator<Model> = async (fields, ignore) => {
    const record = await model.findFirst({ where: fields })

    if (record === null) return true
    if (ignore) {
      const shouldIgnore = Object.entries(ignore).every(([key, value]) => record[key] === value)
      if (shouldIgnore) return true
    }
    return false
  }
  return validator
}

export function modelValidator<Model extends PrismaModel>(model: Model): ModelValidator<Model> {
  return {
    isUnique: createUniqueValidator(model),
  }
}
```

å­˜åœ¨ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹æ©Ÿä¼šãŒã‚ã‚Œã°ã€`exists`ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚è¿½åŠ ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚
